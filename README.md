# Домашнее задание к занятию "`Резервное копирование баз данных`" - `Дёмин Максим`


### Задание 1

Что нужно сделать:

Резервное копирование

Кейс

Финансовая компания решила увеличить надёжность работы баз данных и их резервного копирования.

Необходимо описать, какие варианты резервного копирования подходят в случаях:

1.1. Необходимо восстанавливать данные в полном объёме за предыдущий день.

1.2. Необходимо восстанавливать данные за час до предполагаемой поломки.

1.3.* Возможен ли кейс, когда при поломке базы происходило моментальное переключение на работающую или починенную базу данных.

Приведите ответ в свободной форме.

### Решение:

1.1. Нужно восстанавливать данные полностью за предыдущий день

Подходящие варианты:

Вариант 1: ежедневный полный бэкап (Full backup).

Делается полная копия базы 1 раз в сутки (обычно ночью).

Если что-то случилось - берём вчерашний полный бэкап и восстанавливаем.

Плюсы: максимально просто понять и восстановить.

Минусы: долго делается и много места.

Вариант 2: полный + дифференциальный (Differential).

Например: раз в неделю полный, каждый день дифференциальный (изменения с момента последнего полного).

Для восстановления за вчера: нужно последний полный + вчерашний дифференциальный.

Плюсы: быстрее ежедневные копии, меньше места.

Минусы: восстановление чуть сложнее.

1.2. Нужно восстановить данные за час до предполагаемой поломки

Тут нужен режим восстановления до точки во времени (Point-in-Time Recovery, PITR).

Идея PITR:

Делаем базовую полную копию (base backup / full backup).

Постоянно сохраняем журналы изменений (транзакционные логи).

При аварии восстанавливаем полный бэкап и докручиваем журналы до нужного времени, например до минус 1 час.

Что такое “журналы”:

PostgreSQL: WAL (Write-Ahead Log) - архивирование WAL + restore до времени.

MySQL: binary log (binlog) - затем проигрывание событий до нужного времени.

Плюсы PITR:

Можно восстановиться не только на вчера, а почти на любой момент (хоть на 12:15).

Минусы:

Нужно заранее настроить логирование/архивацию, место под логи и дисциплину хранения.

1.3.* Возможен ли кейс моментального переключения на рабочую/починенную БД?

Да, возможен. Но это уже больше про высокую доступность (High Availability, HA), а не про классический бэкап.

Как это обычно делается:

Есть основная БД (primary/master) и реплика (standby/replica), которая получает изменения почти в реальном времени.

При аварии primary система выполняет failover - реплика становится новой основной.

Переключение может быть:

ручным (администратор переключает),

автоматическим (кластерный менеджер/оркестратор + виртуальный IP/прокси).

Важно понимать:

Репликация ≠ резервная копия.

Если случайно удалили таблицу на primary, это удаление обычно реплицируется на реплику. Поэтому бэкапы всё равно нужны.

### Задание 2

Что нужно сделать:

PostgreSQL

2.1. С помощью официальной документации приведите пример команды резервирования данных и восстановления БД (pgdump/pgrestore).

2.1.* Возможно ли автоматизировать этот процесс? Если да, то как?

Приведите ответ в свободной форме.

### Решение:

2.1. Пример команды резервирования и восстановления (pg_dump / pg_restore) по официальной документации

Простой SQL-дамп (текстовый файл):

Резервное копирование:
```
pg_dump dbname > dumpfile
```
Восстановление:
```
psql -X dbname < dumpfile
```
Архивный формат (удобно для pg_restore, можно выборочно восстанавливать объекты):

Бэкап в custom-формате:
```
pg_dump -Fc dbname > filename
```
Восстановление:
```
pg_restore -d dbname filename
```

2.1.* Можно ли автоматизировать? Если да - как?

Да. Самая базовая автоматизация:

Скрипт [bash](manager_db.sh), который:

запускает pg_dump,

складывает файл в каталог /backups,

добавляет дату в имя,

удаляет старые бэкапы (например, старше 14 дней).

Запуск по расписанию:

cron (классический вариант в Linux),

или systemd timer (более современно и управляемо).

Практика по нормальному (кратко, но по делу):

хранить бэкапы не на той же машине, где база (иначе при поломке диска всё пропадёт),

периодически делать тестовое восстановление (иначе можно узнать, что бэкап “битый”, только в момент аварии).

### Задание 3

Что нужно сделать:

MySQL

3.1. С помощью официальной документации приведите пример команды инкрементного резервного копирования базы данных MySQL.

3.1.* В каких случаях использование реплики будет давать преимущество по сравнению с обычным резервным копированием?

Приведите ответ в свободной форме.

### Решение:

3.1. Пример команды инкрементного резервного копирования MySQL (официальная документация)

В MySQL инкрементность часто делается через binary logs (binlog): полный бэкап + применение binlog для “докрутки” изменений 
(это прямо описано как Point-in-Time / Incremental Recovery). 

Пример применения binlog (из официальной документации):
```
mysqlbinlog binlog_files | mysql -u root -p
MySQL Developer Zone
```
Также официальный пример:
```
mysqlbinlog --read-from-remote-server --host=host_name --port=3306 --user=root --password --ssl-mode=required binlog_files | mysql -u root -p
MySQL Developer Zone
```
Как это связано с инкрементным бэкапом

Полный бэкап вы делаете, например, раз в сутки.

Инкремент - это binlog-сегменты, которые содержат изменения после полного бэкапа.

При восстановлении: сначала полный бэкап, потом проигрываете binlog до нужного момента.

Если брать MySQL Enterprise Backup, там есть прямые команды incremental backup. Например (из документации):
```
mysqlbackup --defaults-file=/home/dbadmin/my.cnf \
  --incremental --incremental-base=history:last_backup \
  --backup-dir=/home/dbadmin/temp_dir \
  --backup-image=incremental_image1.bi \
   backup-to-image
```
3.1.* Когда реплика даёт преимущество по сравнению с обычным бэкапом?

Реплика выигрывает, когда важны минимальный простой и быстрый возврат в работу:

Быстрое восстановление сервиса (низкий downtime).

Если мастер упал, реплику можно промотировать (failover) и продолжить работу быстрее, чем разворачивать бэкап.

Меньше потеря данных.

Реплика обычно отстаёт на секунды/минуты в зависимости от настроек, а бэкап раз в сутки - следовательно это потенциальная потеря до 24 часов.

Снятие нагрузки:

можно делать тяжёлые отчёты/чтение с реплики,

можно делать бэкап с реплики, чтобы не тормозить основной сервер.

Но важно:

реплика не заменяет бэкап, потому что:

случайные удаления/ошибки/вредоносные изменения часто реплицируются тоже,

логическая ошибка приложения так же попадет на реплику.
